<!DOCTYPE html>
<html lang="zh">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>授权 - EasyAPI服务平台</title>
    <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://static.easyapi.com/styles/base.css" rel="stylesheet" />
    <link href="https://cdn.bootcss.com/jQuery-Validation-Engine/2.6.4/validationEngine.jquery.min.css" rel="stylesheet" />
    <meta name="descriptions" content="EasyAPI账号登录" />
    <meta name="keywords" content="登录" />
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="./authorize.css" rel="stylesheet" type="text/css" />
  </head>

  <body>
    <div style="margin: 0 0 100px 0">
      <div class="toper">
        <div class="wp">
          <a href="https://www.easyapi.com/"><img class="logo pl" src="https://static.easyapi.com/images/logo.png" /></a>
        </div>
      </div>
    </div>

    <div class="wrapper">
      <div class="w_top">

        <div class="word_top">
          <span>Easyapi发票管理<span>
              <span>想要访问你的账户信息</span>
        </div>

        <div class="word_bottom">
          <span>当前登录账号<span>
              <span>18756407025</span>
        </div>

      </div>
      <div class="w_bottom">
        <div class="btn_w">
          <div class="btn_left">
            <input id="btn_sub" type="button" name="login" class=" btn-block btn btn-lg btn-info" value="授 权" onclick="accredit()" />
          </div>
          <div class="btn_right">
            <input id="btn_sub" type="button" name="login" class=" btn-block btn btn-lg btn-info" value="取 消" onclick="cancel()" />
          </div>
        </div>

      </div>
    </div>


    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      var scope

      var token = sessionStorage['token'];

      var url = window.location.search; //获取url中"?"符后的字串

      var theRequest = new Object(); //将URL后面的参数解析成对象
      if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        strs = str.split("&");
        for (var i = 0; i < strs.length; i++) {
          theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
        }
      }
      console.log(theRequest)

      $.ajax({
        type: 'GET',
        url: 'http://10.0.0.92:8084/oauth/authorize',
        data: theRequest,
        dataType: "json",
        async: true,
        beforeSend: function(request) {
          request.setRequestHeader("Authorization", "Bearer " + (token));
        },
        success: function(data) {
          console.log(data.content.scope)
          scope = data.content.scope
        },
        error: function(res) {
          console.log(res.status)
          if (res.status == 403) {
            console.log("去登录")
            window.location.href = "http://127.0.0.1:8848/easyapi-account/auth/login.html";
          }
        }
      })

      //授权
      function accredit() {

        $.ajax({
          type: 'POST',
          url: 'http://10.0.0.92:8084/oauth/authorize',
          data: {
            user_oauth_approval: true,
            authorize: "Authorize",
            "scope.ROLE_ADMIN": true
          },
          contentType: "application/x-www-form-urlencoded",
          // dataType: "json",
          // processData: false,
          async: true,
          beforeSend: function(request) {
            request.setRequestHeader("Authorization", "Bearer " + (token));
          },
          success: function(data) {
            console.log(data)
          },
          error: function(res) {
            console.log(res.status)
          }
        })
      }

      //取消
      function cancel() {

        $.ajax({
          type: 'GET',
          url: 'http://10.0.0.92:8084/oauth/authorize',
          data: theRequest,
          dataType: "json",
          async: true,
          beforeSend: function(request) {
            request.setRequestHeader("Authorization", "Bearer " + (token));
          },
          success: function(data) {
            console.log(data.content.scope)
            scope = data.content.scope
          },
          error: function(res) {
            console.log(res.status)
            if (res.status == 403) {
              console.log("去登录")
              window.location.href = "http://127.0.0.1:8848/easyapi-account/auth/login.html";
            }
          }
        })
      }
    </script>
  </body>

</html>
