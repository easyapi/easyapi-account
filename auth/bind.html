<html lang="zh"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>用户绑定 - EasyAPI服务平台</title>
  <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://static.easyapi.com/styles/base.css" rel="stylesheet">
  <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
  <link rel="stylesheet" href="https://static.easyapi.com/layer/skin/layer.css" id="layui_layer_skinlayercss" style=""></head>
<body>

<div style="margin: 0 0 100px 0">
  <div class="toper">
    <div class="wp">
      <a href="https://www.easyapi.com/"><img class="logo pl" src="https://static.easyapi.com/images/logo.png"></a>
      <div class="navs pr">
        <a href="/login">登录</a>
        <a href="/signup">注册</a>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="lg-form yahei">

    <div class="lg-title">绑定账号</div>
    <div class="lg-subtitle ">第一次使用QQ帐号登录，您需要填写邮箱和密码，以后您也可以使用此邮箱和密码登录</div>
    <div class="ath"><img src="https://static.easyapi.com/images/ath.png"><img src="https://static.easyapi.com/images/ath.png"></div>
    <div class="lg-body bgf">
      <form method="post" class="login-form" id="loginForm" onsubmit="return handleLogin();">
        <input type="hidden" id="providerUserId" name="providerUserId" value="63C39A18D7810D42352CE0B37CC0BBC2">
        <input type="hidden" id="providerId" name="providerId" value="qq">
        <div id="alert" class="alert fade in alert-warning none">
          无效用户名或密码，请重试。
        </div>
        <br>
        <div class="form-group">
          <input datatype="e" nullmsg="请输入邮箱" errormsg="邮箱格式有误！" class="form-control" id="username" placeholder="请输入您注册时填写的邮箱" name="username" type="text">
        </div>
        <div class="form-group">
          <input nullmsg="请输入密码！" placeholder="请输入密码" datatype="*" class="form-control" type="password" name="password" id="password">
        </div>
        <div class="checkbox">
          <label>
            <input type="checkbox" name="rememberMe" id="rememberMe" checked="checked">
            记住密码 </label> <span class="Validform_checktip Validform_right" id="msg2"></span>
        </div>

        <input id="btn_sub" type="submit" name="login" class=" btn-block btn btn-lg btn-info" value="绑定账号">
      </form>
    </div>
  </div>
</div>

<div class="foot clearfix">
  <p>
    <a href="https://www.easyapi.com/info/about">关于我们</a>
    <a href="https://www.easyapi.com/info/together">合作伙伴</a>
    <a href="https://www.easyapi.com/info/contact">联系我们</a>
    <a href="https://www.easyapi.com/info/donate">支持我们</a>
  </p>
  <p>Copyright © 2014～2017 上海帮趣网络技术有限公司</p>
</div>

<script src="https://cdn.bootcss.com/jquery/3.5.1/jquery.min.js" type="text/javascript"></script>
<script src="https://cdn.bootcss.com/twitter-bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://static.easyapi.com/scripts/base.js"></script>
<script type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/layer/3.1.1/layer.min.js"></script>
<script type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/layer/3.1.1/layer.min.js"></script>
<script type="text/javascript" src="https://cdn.bootcss.com/jQuery-JSONP/2.4.0/jquery.jsonp.min.js"></script>
<script type="text/javascript" src="https://static.easyapi.com/scripts/libs/Validform_v5.3.2_min.js"></script>
<script type="text/javascript">

  $(document).ready(function () {
    $("#loginForm").Validform({
      tiptype: function (msg, o, cssctl) {
        var objtip = $("#msg2");
        cssctl(objtip, o.type);
        objtip.text(msg);
      },
    });
  });

  function handleLogin() {
    $.ajax({
      method: 'POST',
      url: '/api/authenticate',
      cache: false,
      contentType: 'application/json',
      data: JSON.stringify({
        username: $("#username").val(),
        password: $("#password").val(),
        rememberMe: $("#rememberMe").is(":checked")
      }),
      processData: false,
      dataType: 'json',
      success: function (data, status, xhr) {
        var bearerToken = xhr.getResponseHeader("Authorization");
        if (bearerToken.substr(0, 7) == "Bearer ") {
          var jwt = bearerToken.substr(7, bearerToken.length);
          if ($("#rememberMe").is(":checked")) {
            localStorage.setItem('authenticationToken', jwt);
          } else {
            sessionStorage.setItem('authenticationToken', jwt);
          }
          bind();
        }
      },
      error: function () {
        $("#alert").removeClass("none");
      }
    });
    return false;
  }

  function bind() {
    $.ajax({
      method: 'POST',
      url: '/auth/bind',
      data: {
        providerUserId: $("#providerUserId").val(),
        providerId: $("#providerId").val()
      },
      beforeSend: function (request) {
        request.setRequestHeader("Authorization", "Bearer " + (localStorage.getItem("authenticationToken") == null ? sessionStorage.getItem("authenticationToken") : localStorage.getItem("authenticationToken")));
      },
      dataType: "text",
      success: function (data) {
        window.location.replace("https://www.easyapi.com");
      },
      error: function (data) {
        window.location.replace("/login");
      }
    });
  }

</script>

</body></html>
