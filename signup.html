<!DOCTYPE html>
<html lang="zh">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>注册 - EasyAPI服务平台</title>
    <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <!-- <link href="https://static.easyapi.com/styles/base.css" rel="stylesheet"/> -->
    <link href="http://localhost:9696/styles/base.css" rel="stylesheet" />
    <meta name="descriptions" content="EasyAPI账号注册" />
    <meta name="keywords" content="注册" />
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <!-- 引入element样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
      .flex {
      display: flex;
      justify-content: space-between;
    }

    .flex > input {
      width: 220px;
    }

    #sendCodeBtn{
      background: transparent;
      border: 1px solid #ced4da;
      outline: none;
      height: 47px;
      border-radius: .25rem;
      font-size: 14px;
      width: 120px;
      margin-left: 5px;
    }

    #sendCodeBtn:active{
      background: #fafafa;
    }
    #btn_sub {
      cursor: pointer;
    }

    .disabled {
      cursor: no-drop;
    }
  </style>
  </head>

  <body>
    <div id="app">
      <div style="margin: 0 0 100px 0">
        <div class="toper">
          <div class="wp">
            <a href="https://www.easyapi.com/"><img class="logo pl" src="https://static.easyapi.com/images/logo.png" /></a>
            <div class="navs pr">
              <a href="./login.html">登录</a>
              <a href="./signup.html">注册</a>
            </div>
          </div>
        </div>
      </div>

      <div class="container mt">
        <div class="lg-form">
          <div class="lg-title text-center">用户注册</div>
          <div class="lg-body bgf">
            <br />
            <el-form :model="ruleForm" :rules="rules" ref="ruleForm" label-width="100px" class="demo-ruleForm">
              <el-form-item label="" prop="username">
                <el-input placeholder="请输入手机号码" v-model="ruleForm.username" @input="findUsernameV" style="width: 350px;"></el-input>
              </el-form-item>
              <el-form-item label="" prop="code">
                <el-input placeholder="请输入验证码" v-model="ruleForm.code" style="width: 220px;"></el-input>
                <input type="button" id="sendCodeBtn" @click="sendCodeV" value="获取验证码" />
              </el-form-item>
              <el-form-item label="" prop="nickname">
                <el-input placeholder="请输入姓名" v-model="ruleForm.nickname" style="width: 350px;"></el-input>
              </el-form-item>
              <el-form-item label="" prop="password">
                <el-input placeholder="请设置密码" v-model="ruleForm.password" style="width: 350px;"></el-input>
              </el-form-item>
              <el-form-item label="" prop="confirmPassword">
                <el-input placeholder="请再输入一次密码" v-model="ruleForm.confirmPassword" style="width: 350px;"></el-input>
              </el-form-item>
              <el-checkbox v-model="ruleForm.checked">点击注册表示您同意<span class="text-success"><a href="terms.html" target="_blank">《EasyAPI服务条款》</a></span></el-checkbox>
              <input disabled id="btn_sub" type="button" name="login" @click="onSubmit" class="btn-block btn btn-lg btn-info"
                value="注 册" />
            </el-form>

            <!-- <div class="form-group">
              <input id="username" datatype="m" nullmsg="请输入手机号码" errormsg="手机号码格式有误！" name="user.username" type="text"
                size="20" class="form-control" alt="用户名" placeholder="请输入手机号码" validate="['required']" onblur="return findUsername();">
            </div>
            <div class="form-group flex">
              <input id="code" datatype="s" nullmsg="请输入验证码" name="user.code" type="text" size="20" class="form-control"
                alt="验证码" placeholder="验证码" validate="['required']">
              <button id="sendCodeBtn" onclick="sendCode()">获取验证码</button>
            </div>
            <div class="form-group">
              <input id="nickname" datatype="s" nullmsg="请输入姓名！" name="user.nickname" type="text" size="20" class="form-control"
                alt="昵称" placeholder="请输入昵称" validate="['required']">
            </div>
            <div class="form-group">
              <input id="password" name="user.password" type="password" size="20" class="form-control" alt="登录密码"
                datatype="*6-16" nullmsg="请设置密码！" errormsg="密码范围在6~16位之间" placeholder="密码6~16位之间，建议包含英文和标点符号" validate="['required']"
                onblur="return validPassword();">
            </div>
            <div class="form-group">
              <input id="confirmPassword" name="user.confirmPassword" size="20" type="password" class="form-control"
                datatype="*" recheck="user.password" nullmsg="请再输入一次密码" placeholder="请再输入一次密码" validate="['required']">
            </div>
            <div class="checkbox">
              <label>
                <input type="checkbox" id="checkButton" checked> 点击注册表示您同意<span class="text-success"><a href="terms.html"
                    target="_blank">《EasyAPI服务条款》</a></span>
              </label>
            </div> -->
            <!-- <div class="form-group">
              <input onclick="signup()" id="btn_sub" id="signupBtn" name="signupBtn" class="btn-block btn btn-lg btn-info"
                value="注 册" />
            </div> -->

            <div class="otherbox">
              <a href="./login.html" class="btn  btn-lg btn-default">我已有EasyAPI账号，直接登录</a>
            </div>

          </div>
        </div>
      </div>

      <div class="foot clearfix">
        <p>
          <a href="https://www.easyapi.com/info/about">关于我们</a>
          <a href="https://www.easyapi.com/info/together">合作伙伴</a>
          <a href="https://www.easyapi.com/info/contact">联系我们</a>
          <a href="https://www.easyapi.com/info/donate">支持我们</a>
        </p>
        <p>Copyright © 2014～2020 上海帮趣网络技术有限公司</p>
      </div>
    </div>
    <!-- 引入vue -->
    <script src="./vue/vue.min.js" type="text/javascript" charset="utf-8"></script>
    <!-- 引入elemnet组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.5.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdn.bootcss.com/twitter-bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://static.easyapi.com/scripts/base.js"></script>
    <script type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/layer/3.1.1/layer.min.js"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/jQuery-JSONP/2.4.0/jquery.jsonp.min.js"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="https://static.easyapi.com/scripts/libs/Validform_v5.3.2_min.js"></script>
    <script type="text/javascript">
      let from = "";
      if (from != null && from != '') {
        var expiresDate = new Date();
        expiresDate.setTime(expiresDate.getTime() + (60 * 60 * 1000));
        $.cookie('from', from, {
          expires: expiresDate
        });
      } else {
        from = $.cookie("from");
      }
      if (typeof(from) == "undefined") {
        from = '';
      }
      from = from != "" ? from : document.referrer;
      from = from.indexOf("account.easyapi.com") >= 0 ? "https://www.easyapi.com" : from;

      $(function() {
        $("#signupForm").Validform({
          tiptype: 3
        });
      })

      function checkPhone(phone) {
        if (!(/^1([358][0-9]|4[579]|66|7[0135678]|9[89])[0-9]{8}$/.test(phone))) {
          return false;
        }
        return true
      }

      function findUsername() {
        if ($("#username").val() == '') {
          layer.msg("请输入手机号码");
          return false;
        }
        if (!checkPhone($("#username").val())) {
          layer.msg("请输入正确的手机号");
          return false;
        }
        $.ajax({
          url: "https://account-api.easyapi.com/api/account/find",
          contentType: 'text/plain',
          method: "POST",
          data: $("#username").val(),
          dataType: "text",
          success: function(data) {
            layer.msg("此手机号码已经被人注册");
            return false;
          }
        });
        return true;
      }

      function validPassword() {
        if ($("#password").val().length < 6 || $("#password").val().length > 16) {
          layer.msg("密码范围在6~16位之间");
          return false
        }
        return true
      }

      let timer

      function sendCode() {

        if (!checkPhone($("#username").val())) {
          layer.msg("请输入正确的手机号");
        }
        if (!$("#username").val() == '' && checkPhone($("#username").val())) {
          $.ajax({
            url: "https://account-api.easyapi.com/api/account/find",
            contentType: 'text/plain',
            method: "POST",
            data: $("#username").val(),
            dataType: "text",
            success: function(data) {
              layer.msg("此手机号码已经被人注册");
            },
            error: function(data) {
              $.ajax({
                url: "https://account-api.easyapi.com/api/captcha/send",
                method: "POST",
                contentType: 'application/json',
                data: JSON.stringify({
                  mobile: $("#username").val()
                }),
                success: function(data) {
                  layer.msg("验证码发送成功", {
                    icon: 1,
                    time: 2000
                  });
                }
              });
              let btn = $("#sendCodeBtn")
              var second = 60;
              btn.attr('disabled', true).addClass('disabled');
              timer = setInterval(() => {
                second--;
                if (second == 0) {
                  btn.val('获取验证码');
                  btn.attr('disabled', false).removeClass('disabled');
                  clearInterval(timer)
                  return
                }
                btn.val(`剩余${second}秒`);
              }, 1000)
            }
          });
        }
      }

      function signup() {
        var username = $("#username").val();
        var code = $("#code").val();
        var nickname = $("#nickname").val()
        var password = $("#password").val()
        var confirmPassword = $("#confirmPassword").val()
        if (password != confirmPassword) {
          layer.msg("确认密码不一致");
          return false;
        }
        var checkbox = $("#checkButton")[0].checked
        if (!checkbox) {
          layer.msg("请勾选同意EasyAPI用户协议");
          return false;
        }
        $.ajax({
          method: 'POST',
          url: 'https://account-api.easyapi.com/api/account/signup',
          contentType: 'application/json',
          data: JSON.stringify({
            code: $("#code").val(),
            username: $("#username").val(),
            nickname: $("#nickname").val(),
            password: $("#password").val()
          }),
          dataType: "json",
          success: function(data) {
            window.location.replace(from);
          },
          error: function(data) {
            layer.msg(data.responseJSON.message, {
              icon: 2,
              time: 2000
            });
          }
        });
        return false;
      }

      var vm = new Vue({
        el: '#app',
        data: {
          ruleForm: {
            username: '',
            code: '',
            nickname: '',
            password: '',
            confirmPassword: '',
            checked: false,
          },
          rules: {
            username: [{
                required: true,
                message: '请输入手机号码',
                trigger: 'blur'
              },
              {
                pattern: /^1[34578]\d{9}$/,
                message: '手机号码格式有误',
                trigger: 'change'
              }
            ],
            code: [{
                required: true,
                message: '请输入验证码',
                trigger: 'blur'
              },
              {
                type: 'number',
                message: '请输入正确的验证码',
                trigger: 'blur'
              }
            ],
            nickname: [{
              required: true,
              message: '请输入昵称',
              trigger: 'blur'
            }],
            password: [{
                required: true,
                message: '密码6~16位之间，建议包含英文和标点符号',
                trigger: 'blur'
              },
              {
                min: 6,
                max: 16,
                message: '密码6~16位之间，建议包含英文和标点符号',
                trigger: 'change'
              }
            ],
            confirmPassword: [{
              required: true,
              message: '请再输入一次密码',
              trigger: 'blur'
            }],
          }
        },
        methods: {
          onSubmit(formName) {
            let that = this
            console.log(this.ruleForm)

          },
          //在手机号输入正确之后查询是否有此用户
          findUsernameV() {
            let that = this
            var telStr = /^1[34578]\d{9}$/
            if (telStr.test(this.ruleForm.username)) {
              $.ajax({
                url: "https://account-api.easyapi.com/api/account/find",
                contentType: 'text/plain',
                method: "POST",
                data: that.ruleForm.username,
                dataType: "text",
                success: function(data) {
                  that.$message.error('此手机号码已经被人注册');
                }
              });
            }
          },

          //发送验证码
          sendCodeV() {
            let that = this
            let timer

            var telStr = /^1[34578]\d{9}$/
            if (telStr.test(that.ruleForm.username)) {
              $.ajax({
                url: "https://account-api.easyapi.com/api/account/find",
                contentType: 'text/plain',
                method: "POST",
                data: that.ruleForm.username,
                dataType: "text",
                success: function(data) {
                  that.$message.error('此手机号码已经被人注册');
                },
                error: function(data) {
                  $.ajax({
                    url: "https://account-api.easyapi.com/api/captcha/send",
                    method: "POST",
                    contentType: 'application/json',
                    data: JSON.stringify({
                      mobile: that.ruleForm.username
                    }),
                    success: function(data) {
                      that.$message({
                        message: '验证码发送成功',
                        type: 'success'
                      });
                    }
                  });
                  let btn = $("#sendCodeBtn")
                  var second = 60;
                  btn.attr('disabled', true).addClass('disabled');
                  timer = setInterval(() => {
                    second--;
                    if (second == 0) {
                      btn.text('获取验证码');
                      btn.attr('disabled', false).removeClass('disabled');
                      clearInterval(timer)
                      return
                    }
                    btn.text(`剩余${second}秒`);
                  }, 1000)
                }
              });

            }else{
              that.$message.error('请输入正确的手机号码');
            }

          }

          //用户名和密码没输入按置灰
          // passwordInput(e) {
          //   var telStr = /^1[34578]\d{9}$/
          //   console.log(telStr.test(this.ruleForm.name))
          //   console.log(this.ruleForm.password.length >= 6)
          //   if (telStr.test(this.ruleForm.name) && this.ruleForm.password.length >= 6) {
          //     $('#btn_sub').removeAttr("disabled");
          //   } else {
          //     $('##btn_sub').attr("disabled", true);
          //   }
          // }
        },
        mounted() {

        }
      })
    </script>
  </body>

</html>
